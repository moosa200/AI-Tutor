generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Attempt {
  id             String   @id @default(cuid())
  userId         String
  questionId     String
  selectedOption String?
  answers        Json?
  score          Int
  maxScore       Int
  feedback       Json
  timeSpent      Int?
  isCorrect      Boolean?
  mistakeTags    String[]
  createdAt      DateTime @default(now())
  question       Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@index([userId, createdAt(sort: Desc)])
}

model ChatMessage {
  id        String   @id @default(cuid())
  userId    String
  role      String
  content   String
  createdAt DateTime @default(now())

  @@index([userId])
}

model Question {
  id             String         @id @default(cuid())
  year           Int
  paper          Int
  questionNumber Int
  topic          String
  topicId        String?
  type           QuestionType   @default(STRUCTURED)
  totalMarks     Int
  questionText   String?
  optionA        String?
  optionB        String?
  optionC        String?
  optionD        String?
  correctOption  String?
  explanation    String?
  images         Json?
  difficulty     String?        @default("medium")
  topics         String[]
  syllabus       String         @default("9702")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @default(now()) @updatedAt
  attempts       Attempt[]
  Topic          Topic?         @relation(fields: [topicId], references: [id])
  parts          QuestionPart[]

  @@index([difficulty])
  @@index([topic])
  @@index([type])
  @@index([year, paper])
}

model QuestionPart {
  id         String            @id @default(cuid())
  questionId String
  partLabel  String
  partText   String
  marks      Int
  inputType  InputType         @default(TEXT)
  images     Json?
  markScheme Json
  order      Int
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @default(now()) @updatedAt
  question   Question          @relation(fields: [questionId], references: [id], onDelete: Cascade)
  subParts   QuestionSubPart[]

  @@index([questionId])
}

model QuestionSubPart {
  id           String       @id @default(cuid())
  partId       String
  subPartLabel String
  subPartText  String
  marks        Int
  inputType    InputType    @default(TEXT)
  images       Json?
  markScheme   Json
  order        Int
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @default(now()) @updatedAt
  part         QuestionPart @relation(fields: [partId], references: [id], onDelete: Cascade)

  @@index([partId])
}

model Topic {
  id          String     @id @default(cuid())
  name        String     @unique
  level       String
  description String?
  status      String     @default("not_started")
  questions   Question[]
}

model User {
  id        String    @id @default(cuid())
  clerkId   String    @unique
  email     String    @unique
  createdAt DateTime  @default(now())
  attempts  Attempt[]
}

enum InputType {
  NUMERICAL
  TEXT
  LONG_TEXT
  MCQ_INLINE
}

enum QuestionType {
  MCQ
  STRUCTURED
}
